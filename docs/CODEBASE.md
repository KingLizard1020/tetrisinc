AI GENERATED DOCUMENTATION 
# Codebase Documentation

Terminal, ncurses-based Tetris implementation with persistence, animations, and automated tests.

## Build & Run
- `make` – compiles the ncurses application and test binaries into `build/`.
- `./build/terminal_tetris` – launches the interactive game.
- `make test` – builds and executes all unit tests under `tests/`.

## Source Files Overview
- `src/main.c` – thin entry point that wires process lifetime to the game module.
- `src/game.c` – full game engine: input loop, board state, rendering, scoring, animations, overlays.
- `src/board.c` – board helper routines (collision, locking, clearing).
- `src/bag.c` – seven-bag randomizer for piece sequencing.
- `src/piece.c` – compile-time definitions of tetrominoes plus accessors.
- `src/score.c` – scoring logic and high-score persistence.
- Headers in `include/` expose the public interfaces for each module.
- `tests/*.c` – focused unit tests for every subsystem (bag, board, gravity, piece, score).

## `src/main.c`
| Function | Description |
| --- | --- |
| `main` | Initializes the game, runs the main loop, shuts down ncurses, and returns the appropriate exit code. |

## `src/game.c` (Game Loop, State Machine, Rendering)
| Function | Description |
| --- | --- |
| `game_init` | Sets up ncurses, keyboard handling, color pairs, RNG seeding, score persistence, and resets all gameplay state. |
| `game_loop` | Reads non-blocking input, measures frame delta, advances gameplay, updates animation timers, and renders frames until the user quits. |
| `game_shutdown` | Restores the terminal by calling `endwin`. |
| `draw_frame` | Clears the screen, renders the board, HUD, overlays, and refreshes the window each frame. |
| `has_enough_space` | Ensures the terminal window meets the minimum required rows/columns before rendering. |
| `draw_banner` | Prints instructions/status text in the upper-left corner based on the current game state. |
| `draw_board` | Draws the playfield border and locked cells, highlighting any lines currently flashing. |
| `draw_ghost_piece` | Projects the active piece to its eventual landing row and renders it dimly as a placement guide. |
| `draw_active_piece` | Renders the currently falling tetromino using the active rotation and position. |
| `handle_input` | Routes key presses to the appropriate handler depending on whether the game is on the title screen, active play, or game-over screen. |
| `update_game` | Advances gravity, handles lock-delay timing, spawns new pieces when needed, and only runs while actively playing. |
| `monotonic_millis` | Returns a millisecond-resolution monotonic timestamp for timing calculations. |
| `spawn_piece` | Pulls the next tetromino from the bag, centers it at the spawn point, and triggers a game over if it collides immediately. |
| `try_move_piece` | Attempts to translate the active piece by the requested row/column offset if the board permits it. |
| `try_rotate_piece` | Attempts to rotate the active piece, ensuring the new orientation fits on the board. |
| `lock_piece` | Copies the active piece’s occupied cells into the board and marks it inactive. |
| `clear_completed_lines` | Wrapper that calls `board_clear_completed_lines` while reusing the shared buffer for cleared-row indices. |
| `current_piece_shape` | Returns the `PieceShape` metadata for the active piece type. |
| `next_piece_shape` | Returns the metadata for the queued next piece, or `NULL` if none is queued. |
| `ensure_next_piece` | Guarantees that the `g_next_piece_type` slot is filled by drawing from the bag when empty. |
| `reset_board_state` | Clears the board, timers, counters, bag, and current score to prepare for a fresh game. |
| `start_new_game` | Resets all state, spawns the first piece, and switches the state machine into `GAME_STATE_PLAYING`. |
| `settle_active_piece` | Finalizes the falling piece, awards hard-drop bonuses, clears lines, updates scores/levels, persists highscores, and spawns the next piece. |
| `begin_lock_delay` | Starts the lock-delay timer once a piece can no longer move downward. |
| `cancel_lock_delay` | Resets the lock-delay timer, typically after the player moves/rotates the piece. |
| `update_level_and_speed` | Bumps the level after enough lines, shortens the gravity interval, and triggers a HUD pulse. |
| `gravity_interval_for_level` | Computes the gravity tick interval for a given level, clamping to a minimum threshold. |
| `trigger_line_flash` | Marks recently cleared line indices and starts the flash timer used during rendering. |
| `record_drop_flash` | Captures every board cell traversed during a hard drop so the trail effect can be drawn. |
| `draw_drop_flash` | Renders the transient trail generated by the last hard drop. |
| `trigger_hud_pulse` | Starts a short pulse timer that tints the HUD after notable events (line clears, level ups). |
| `tick_animation_timers` | Decrements HUD, flash, and drop-trail timers using the last frame’s delta so they expire automatically. |
| `draw_score_panel` | Prints score, high score, level, total lines, and gravity interval, optionally pulsing with color. |
| `draw_next_piece_panel` | Draws a framed preview area and labels it for the upcoming tetromino. |
| `draw_piece_preview` | Renders a miniature representation of a piece inside the preview box. |
| `draw_title_overlay` | Displays the title, controls, and start instructions when in the title state. |
| `draw_game_over_overlay` | Shows final score/line statistics plus restart instructions when the player tops out. |

## `src/board.c`
| Function | Description |
| --- | --- |
| `board_reset` | Clears every board cell to zero. |
| `board_can_place` | Verifies whether a shape/rotation fits at the requested position without collisions or boundary violations. |
| `board_lock_shape` | Writes a shape’s occupied cells into the board array using the provided value. |
| `board_clear_completed_lines` | Detects and removes any fully occupied rows, compacts the board downward, and returns the count while optionally reporting cleared row indices. |

## `src/bag.c`
| Function | Description |
| --- | --- |
| `piece_bag_refill` *(static)* | Refills and shuffles the bag contents using Fisher-Yates so each piece appears exactly once per cycle. |
| `piece_bag_init` | Initializes a bag with a bounded piece count and immediately shuffles it. |
| `piece_bag_next` | Returns the next piece id, automatically triggering a refill when the current bag is exhausted. |

## `src/piece.c`
| Function | Description |
| --- | --- |
| `piece_shape_count` | Returns the total number of tetromino definitions compiled into the game. |
| `piece_shape_get` | Retrieves a `PieceShape` descriptor by index, or `NULL` if the index is invalid. |
| `piece_shape_cell_filled` | Convenience helper to check whether a given local cell is occupied for a specific rotation. |

## `src/score.c`
| Function | Description |
| --- | --- |
| `score_state_init` | Loads the saved high score (if present) and configures the backing file path. |
| `score_state_save` | Writes the current high score to disk. |
| `score_reset_current` | Clears the in-progress run’s score. |
| `score_add_lines` | Applies standard Tetris line-clear scoring for 1–4 simultaneous lines (and extrapolates beyond). |
| `score_add_drop` | Awards points based on the number of rows covered by a hard drop. |
| `score_commit_highscore` | Updates the stored high score when the active run surpasses it and returns whether persistence is needed. |

## Header Files (`include/`)
- `game.h` – declares `game_init`, `game_loop`, and `game_shutdown`.
- `board.h` – board dimensions, structs, and public board helpers.
- `bag.h` – `PieceBag` struct and bag API.
- `piece.h` – `PieceShape`, `ActivePiece`, and shape accessors.
- `score.h` – `ScoreState` struct and scoring API.

## Test Suites (`tests/`)
Each test binary uses basic `run_test` helpers for structured output. Functions are listed per file for traceability.

### `tests/bag_tests.c`
| Function | Description |
| --- | --- |
| `run_test` | Utility that prints a start/end banner around each test. |
| `test_bag_cycle_contains_all` | Ensures a freshly shuffled bag returns every piece exactly once per cycle. |
| `test_bag_multiple_cycles` | Verifies two consecutive cycles contain exactly two copies of each piece. |
| `test_bag_many_cycles_distribution` | Confirms distribution stays uniform over many bag refills. |
| `test_bag_handles_zero_pieces` | Ensures requesting from an empty bag returns `-1`. |
| `main` | Executes all bag tests sequentially. |

### `tests/board_tests.c`
| Function | Description |
| --- | --- |
| `first_shape` | Convenience accessor for the first tetromino definition. |
| `test_board_can_place_empty` | Validates placements succeed on an empty board. |
| `test_board_can_place_blocked` | Confirms placements fail when a cell is already occupied. |
| `test_board_lock_and_clear` | Ensures locking writes cells and line clears remove full rows. |
| `test_board_can_place_left_boundary` | Checks collisions are detected when shifting past the left edge. |
| `test_board_can_place_above_board` | Verifies placements above the visible area are allowed. |
| `test_board_lock_ignores_out_of_bounds_cells` | Confirms locking ignores cells that sit outside the board. |
| `test_board_clear_multiple_lines` | Ensures multiple completed lines are detected and cleared at once. |
| `run_test` | Shared helper for logging test execution. |
| `main` | Runs the board test suite. |

### `tests/piece_tests.c`
| Function | Description |
| --- | --- |
| `run_test` | Standard test harness helper. |
| `test_piece_count_and_rotations` | Asserts every shape is present, has rotations, and each rotation string exists. |
| `test_piece_shape_cell_accessor` | Validates the `piece_shape_cell_filled` helper on known coordinates. |
| `main` | Runs the piece tests. |

### `tests/score_tests.c`
| Function | Description |
| --- | --- |
| `cleanup_file` | Removes temporary score files between tests. |
| `test_score_init_without_file` | Ensures initialization succeeds when the score file is missing. |
| `test_score_line_awards` | Checks line scoring matches the expected table. |
| `test_score_line_overflow_award` | Verifies high line counts still award points. |
| `test_score_persistence` | Exercises saving/loading highscores between runs. |
| `test_score_drop_award_and_reset` | Confirms drop bonuses accrue and resetting clears the score. |
| `test_score_highscore_only_increases` | Ensures highscores only update when the current run beats them. |
| `run_test` | Helper that logs each score test. |
| `main` | Runs the score test suite. |

### `tests/gravity_tests.c`
| Function | Description |
| --- | --- |
| `run_test` | Shared logging helper. |
| `sim_init` | Initializes a lightweight simulation state for gravity/locking checks. |
| `sim_try_move` | Attempts to move the simulated piece and resets lock ticks on downward motion. |
| `sim_gravity_step` | Steps gravity once, applying lock-delay rules and locking when needed. |
| `test_gravity_moves_piece_to_bottom` | Ensures repeated gravity steps eventually lock the piece at the bottom. |
| `test_lock_delay_requires_multiple_ticks` | Verifies pieces do not lock until the lock-delay threshold passes. |
| `test_lateral_move_resets_lock_timer` | Confirms horizontal motion keeps a piece from locking immediately. |
| `test_hard_drop_matches_stepwise_fall` | Checks that a hard drop lands in the same row as incremental gravity. |
| `main` | Runs the gravity tests. |

## Supporting Files
- `README.md` – project overview, feature list, and usage instructions.
- `Makefile` – build targets for the game and all tests.
- `.gitignore` – excludes build artifacts/high-score files from Git.
- `highscore.dat` – default high score persistence file (created/updated at runtime).
